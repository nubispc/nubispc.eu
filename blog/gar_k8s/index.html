<!doctype html><!-- This site was created with Hugo Blox. https://hugoblox.com --><!-- Last Published: February 19, 2026 --><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo Blox Builder 5.9.7"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/css/vendor-bundle.min.26c458e6907dc03073573976b7f4044e.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css integrity crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=/css/wowchemy.0a92100ca9cf271dc93dd61885c3d747.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><meta name=author content="Charalampos Mainas"><meta name=description content="As per a well-known and established definition:"><link rel=alternate hreflang=en-us href=/blog/gar_k8s/><link rel=canonical href=/blog/gar_k8s/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu_76f04f0ed4ada794.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu_bbf9ba2454448482.png><meta name=theme-color content="#1565c0"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@GetResearchDev"><meta property="twitter:creator" content="@GetResearchDev"><meta property="twitter:image" content="/media/logo_hu_866fdf07312224c.png"><meta property="og:type" content="website"><meta property="og:site_name" content="Nubificus"><meta property="og:url" content="/blog/gar_k8s/"><meta property="og:title" content="Build Multi-arch CI pipelines with Github Actions Self-hosted Runners | Nubificus"><meta property="og:description" content="As per a well-known and established definition:"><meta property="og:image" content="/media/logo_hu_866fdf07312224c.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2024-02-05T09:31:04+01:00"><meta property="article:modified_time" content="2024-02-05T09:31:04+01:00"><script src=https://cdn.jsdelivr.net/gh/osano/cookieconsent@3.1.1/build/cookieconsent.min.js integrity="sha512-yXXqOFjdjHNH1GND+1EO0jbvvebABpzGKD66djnUfiKlYME5HGMUJHoCaeE4D5PTG2YsSJf6dwqyUUvQvS0vaA==" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/osano/cookieconsent@3.1.1/build/cookieconsent.min.css integrity="sha512-LQ97camar/lOliT/MqjcQs5kWgy6Qz/cCRzzRzUCfv0fotsCTC9ZHXaPQmJV8Xu/PVALfJZ7BDezl5lW3/qBxg==" crossorigin=anonymous><script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#1565c0",text:"rgb(255, 255, 255)"},button:{background:"rgb(255, 255, 255)",text:"#1565c0"}},theme:"classic",content:{message:"This website uses cookies to ensure you get the best experience on our website.",dismiss:"Got it!",link:"Learn more",href:"https://www.cookiesandyou.com"}})})</script><title>Build Multi-arch CI pipelines with Github Actions Self-hosted Runners | Nubificus</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=59dd9c6e07f2ba4e44f798d21905163d><script src=/js/wowchemy-init.min.9e4214442a7711d35691acd58f6f6361.js></script><div class="page-header header--fixed"><style>.navbar-logo{height:50px;display:flex;align-items:center}.navbar-logo img{max-height:45px;width:auto;display:block}.navbar-logo .logo-dark{display:none}body.colorscheme-dark .navbar-logo .logo-light,body.dark .navbar-logo .logo-light{display:none}body.colorscheme-dark .navbar-logo .logo-dark,body.dark .navbar-logo .logo-dark{display:block}.navbar-logo.logo-nubis,.navbar-logo.logo-nubificus{display:none}</style><script>document.addEventListener("DOMContentLoaded",function(){var e=window.location.hostname,t=e==="nubis-pc.eu"||e==="www.nubis-pc.eu",n=t?"logo-nubis":"logo-nubificus";document.querySelectorAll(".navbar-logo."+n).forEach(function(e){e.style.display="flex"}),document.querySelectorAll("[data-brand]").forEach(function(e){var n=e.getAttribute("data-brand");t?e.textContent=n==="primary"?"Nubis":"Nubificus":e.textContent=n==="primary"?"Nubificus":"Nubis"})})</script><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/><div class="navbar-logo logo-nubificus"><img class=logo-light src=/media/logo-nubificus_hu_7be4fa6b19286a64.png alt=Nubificus>
<img class=logo-dark src=/media/logo-nubificus-dark_hu_bd80a6d6121ee2ff.png alt=Nubificus></div><div class="navbar-logo logo-nubis"><img class=logo-light src=/media/logo-nubis.png alt="Nubis PC">
<img class=logo-dark src=/media/logo-nubis-dark.png alt="Nubis PC"></div></a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/><div class="navbar-logo logo-nubificus"><img class=logo-light src=/media/logo-nubificus_hu_7be4fa6b19286a64.png alt=Nubificus>
<img class=logo-dark src=/media/logo-nubificus-dark_hu_bd80a6d6121ee2ff.png alt=Nubificus></div><div class="navbar-logo logo-nubis"><img class=logo-light src=/media/logo-nubis.png alt="Nubis PC">
<img class=logo-dark src=/media/logo-nubis-dark.png alt="Nubis PC"></div></a></div><div class="navbar-collapse main-menu-item collapse justify-content-end" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/><span>Home</span></a></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Research</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/projects/><span>Projects</span></a>
<a class=dropdown-item href=/publication><span>Publications</span></a></div></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Solutions</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/solutions/edgelink/><span>edgeLink</span></a>
<a class=dropdown-item href=/solutions/urunc/><span>urunc</span></a>
<a class=dropdown-item href=/solutions/vaccel/><span>vAccel</span></a></div></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Feed</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/post><span>News</span></a>
<a class=dropdown-item href=/event><span>Events</span></a></div></li><li class=nav-item><a class="nav-link active" href=/blog><span>Blog</span></a></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>About</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/people><span>People</span></a>
<a class=dropdown-item href=/contact><span>Contact</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span>
</a><a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span>
</a><a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header><script>document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll(".navbar-nav .nav-item.dropdown");e.forEach(function(t){t.addEventListener("mouseenter",function(){e.forEach(function(e){if(e!==t){e.classList.remove("show");var n=e.querySelector(".dropdown-menu");n&&n.classList.remove("show")}}),t.classList.add("show");var n=t.querySelector(".dropdown-menu");n&&n.classList.add("show")}),t.addEventListener("mouseleave",function(){t.classList.remove("show");var e=t.querySelector(".dropdown-menu");e&&e.classList.remove("show")})})})</script></div><div class=page-body><article class=article><div class=article-container><a class=blog-back-link href=javascript:void(0) onclick=blogGoBack()><i class="fas fa-arrow-left"></i> Back to Blog</a></div><div class="article-container pt-3"><h1>Build Multi-arch CI pipelines with Github Actions Self-hosted Runners</h1><div class=article-metadata><span class=article-date>Feb 5, 2024</span></div></div><div class=article-container><div class=article-style><p>As per a well-known and established definition:</p><blockquote><p>&ldquo;Continuous Integration (CI) is the practice of merging all developers&rsquo; working copies to a shared mainline several times a day.&rdquo;</p></blockquote><p><figure id=figure-figure-1-what-is-continuous-integration--source-exoscale><div class="d-flex justify-content-center"><div class=w-100><img src=/images/images/what-is-continuous-integration.png alt="Figure 1: What is continuous integration ? (source: exoscale)" loading=lazy data-zoomable></div></div><figcaption>Figure 1: What is continuous integration ? (source: exoscale)</figcaption></figure></p><p>Continuous Integration practice comes along with the automated testing and verification of the integrated code changes, giving
testing automations the status as one of the pivotal elements in software development. The
automation of testing can range from a few simple scripts, to complex setups,
employing an entire testing suite. However, challenges escalate significantly
when deploying software across diverse architectures (such as amd64, ARM, etc.)
and varied environments (including containers, Kubernetes, bare-metal, etc.).
The emergence of Kubernetes and its extensive software ecosystem, coupled with
the robust tooling provided by Github, has introduced an intriguing perspective
on automating the building and testing phases of software development.</p><p>As a company specializing in systems software, we&rsquo;ve had to innovate to ensure
that our code not only avoids regressions but also remains compatible with
multiple architectures, facilitating deployment in a range of environments.
This talk provides insights into our findings, outlining the use of an
open-source Kubernetes operator built to scale self-hosted Github runners. We
share the intricacies of all customisations necessary to align this solution
with our specific requirements.</p><p>Specifically, we go through a brief introduction of the operator, and dig in
the customization of the runners, built to support various combinations of
system-specific requirements: interact with VM middlewares (libvirt), enable
hardware accelerator access (GPUs), setup a standalone k8s environment, and
finally, automate the building of the runners themselves.</p><p>To wrap up, we showcase a workflow that we use to release vAccel, a software
framework we build, that consists of various individual components, that
eventually interact with each other.</p><h3 id=github-actions>Github Actions</h3><p>Github Actions is the Software Development Life Cycle (SDLC) automation platform introduced by Github. With Github Actions framework, one can create automation workflows as part of the actual software code already stored in Github.</p><p>Github workflows are represented in YAML syntax and it are executed on configured runners.</p><p><figure id=figure-figure-2-github-actions><div class="d-flex justify-content-center"><div class=w-100><img src=/images/images/gh-actions.png alt="Figure 2: Github Actions" loading=lazy data-zoomable></div></div><figcaption>Figure 2: Github Actions</figcaption></figure></p><p>The basic elements of Github Actions framework are:</p><table><thead><tr><th style=text-align:center>Github Actions element</th><th style=text-align:center>Description</th></tr></thead><tbody><tr><td style=text-align:center>Event Triggers</td><td style=text-align:center>starting signals for a Github action to start: operation from a Github repo, manual schedule, external event</td></tr><tr><td style=text-align:center>Workflow</td><td style=text-align:center>workflow is a script consisting of jobs, steps, calling actions or other workflows forming a pipeline</td></tr><tr><td style=text-align:center>Job</td><td style=text-align:center>jobs is an execution block consisting of steps that run on a specific runner</td></tr><tr><td style=text-align:center>Step</td><td style=text-align:center>atomic script code blocks of jobs</td></tr><tr><td style=text-align:center>Action</td><td style=text-align:center>script module consisting of steps and invoked by workflow pipelines</td></tr><tr><td style=text-align:center>Environment</td><td style=text-align:center>building & deployment targets of github workflow pipelines</td></tr><tr><td style=text-align:center>Runner</td><td style=text-align:center>VMs, containers or pods where workflow code is executed</td></tr></tbody></table><p>Github Marketplace is another feature of Github Actions: a public place in Github where a vast number of Github Actions are published and available to use.</p><p>As a systems software company, our deliverables have different software forms: from simple libraries, to executable binaries and whole containerised images. To accommodate the various building, deployment and testing necessities, we have been implementing several Github workflow pipelines with several customised features:</p><ul><li>multi-arch build & unit-test of vAccel components, in self-hosted custom built runners</li><li>multi-arch build & test of vAccel, in self-hosted custom built runners</li><li>SDLC supporting pipelines for automating repeating tasks</li></ul><p>To fulfill the various requirements of system-specific combinations, the following Github workflow components were used:</p><ul><li>bare metal k8s cluster</li><li>evryfs k8s operator</li><li>custom built runner images</li><li>Github option for self-hosted runners</li></ul><p>The following sections of this post describe these custom made components in details.</p><h3 id=self-hosted-runners>Self-hosted Runners</h3><p>Generally speaking, self hosted github runners provide extensive control of hardware, operating system containers with hardware-specific components. We take advantage of these components&rsquo; features to build, execute and maintain a Continuous Integration/Continuous Deployment set of pipelines for the Nubificus multiple hardware architectures solution.</p><p>Let us list some of these Self-hosted runners advantages:</p><ul><li>launching pods in architectures not currently supported by Github hosted runners</li><li>images with hardware specific customisations</li><li>management & maintenance by hosting organization</li><li>implementation in both virtual or physical infrastructure</li><li>maximize volumes & concurrent jobs</li><li>cost efficiency</li><li>persistence, not being ephemeral as Github hosted runners</li></ul><p>To get the maximum out of the Github self-hosted runners capabilities and at the same time enforce the restriction of a multi-arch pipeline ecosystem, we opted to build an elastic kubernetes bare metal environment where self-hosted custom image pod containers would be the beating heart of it.</p><h3 id=evryfs-operator--runners>evryfs operator & runners</h3><p>Kubernetes Operators are software extensions that make use of custom resources to manage applications and their components. Operators are very useful because they are application-specific controllers that extend the functionality of the Kubernetes APIs and manage complex instances of the application for the user.</p><p>For the purposes of scheduling github actions runner pods in our self-hosted runners kubernetes environment and minimize manual actions, we have chosen evryfs/github-actions-runner-operator (evryfs/garo). Evryfs/garo suits our needs for controlling multi-arch autoscaling self-hosted runners for our Github Actions CI/CD ecosystem. Nonetheless, other available operators will be evaluated as part of our future iterations.</p><p>Several re-configurations were necessary in Github for self-hosted runners to get registered, custom labels were introduced for each runner image, and several issues had to get addressed (ex. autoscaling). A Jinja2 script templating mechanism was also introduced to help automate these custom evryfs GithubActionRunner operator definitions.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>garo.tietoevry.com/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>GithubActionRunner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>name }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>actions-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minRunners</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>min_runners }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxRunners</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>max_runners }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>organization</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>organization }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reconciliationPeriod</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podTemplateSpec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runner</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>runner_label }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DOCKER_TLS_CERTDIR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DOCKER_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>tcp://localhost:2376</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DOCKER_TLS_VERIFY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DOCKER_CERT_PATH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/certs/client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GH_ORG</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>gh_org_value }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ACTIONS_RUNNER_INPUT_LABELS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>runner_input_labels_value }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>secret_ref_name }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>runner_image }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>[</span><span class=l>snipped]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DOCKER_TLS_CERTDIR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:stable-dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- --<span class=l>mtu=1430</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/home/runner/_work</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>runner-work</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>exporter_image }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3903</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>[</span><span class=l>snipped]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{{<span class=w> </span><span class=nt>node_selector_value }}</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=build-custom-runner-images>Build custom runner images</h3><p>To build/execute in multiple architectures with specific hardware configurations, we had to instruct github action self-hosted runner operator to spawn runners that use our custom purpose-build docker images stored in our private registry.</p><p>To overcome conflicts and incompatibilities between specific configurations and library/runtime prerequisites and at the same time reduce build time and optimize the Docker images in terms of volume, we had to establish various lineages of custom Github inter-dependent Dockerfile declarations.</p><p>A base Dockerfile (&ldquo;Dockerfile.base&rdquo;) as the &ldquo;core&rdquo; of the custom Dockerfile declarations (derived itself from ubuntu:20.04) which is used as the basic layer upon which most other customer docker images are build.</p><p>This inter-dependent layered dockerfile image structuring in conjunction with the automated runner images build process (described below), significantly reduces delivery times for new custom images necessary for organization&rsquo;s deployment of vaccel framework.</p><h3 id=automate-the-process-of-building-the-runner-images>Automate the process of building the runner images</h3><p>To automate the build and publish process of the custom purpose-built docker images for our github action runners, a Github Action pipeline is implemented. The pipeline checks out the Dockerfile image files and related scripts, along with declarative json file that depicts the custom docker images layering dependencies.</p><p>The Github Action pipeline decomposes the declarative json file, constructs at runtime the relevant build and registry publishing jobs, executes them in the correct order, preserving the Dockerfile layered dependencies. The image artifacts build from &rsquo;lower&rsquo; build level jobs are available as registry images for the &lsquo;higher&rsquo; build level jobs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dockerfile_build_components&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;image_filename&#34;</span><span class=p>:</span> <span class=s2>&#34;Dockerfile.gcc-lite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=s2>&#34;lite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;x86_64&#34;</span><span class=p>,</span> <span class=s2>&#34;aarch64&#34;</span><span class=p>,</span><span class=s2>&#34;armv7l&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;image_filename&#34;</span><span class=p>:</span> <span class=s2>&#34;Dockerfile.rust&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;base_filename&#34;</span> <span class=p>:</span> <span class=s2>&#34;Dockerfile.gcc-lite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=s2>&#34;lite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;x86_64&#34;</span><span class=p>,</span> <span class=s2>&#34;aarch64&#34;</span><span class=p>,</span><span class=s2>&#34;armv7l&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;output_manifest_tag&#34;</span><span class=p>:</span> <span class=s2>&#34;final&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=generate-descriptors-for-all-runners>Generate descriptors for all runners</h3><p><code>runner-ymls</code> is a Python-based tool designed to streamline the deployment of
self-hosted GitHub Actions runners on Kubernetes clusters. Leveraging the
flexibility of Jinja templates, this tool empowers users to easily customize
essential parameters such as runner names, types, container images, custom
resources, and tags. With a focus on simplifying the deployment process, it
dynamically generates Kubernetes YAML descriptors tailored to specific
requirements.</p><p>An example configuration is the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cloudkernels-go&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cloudkernels-go&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;min_runners&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;max_runners&#34;</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;runner_label&#34;</span><span class=p>:</span> <span class=s2>&#34;cloudkernels-go&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;runner_value&#34;</span><span class=p>:</span> <span class=s2>&#34;runner&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;gh_org_value&#34;</span><span class=p>:</span> <span class=s2>&#34;cloudkernels&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;runner_input_labels_value&#34;</span><span class=p>:</span> <span class=s2>&#34;go&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;secret_ref_name&#34;</span><span class=p>:</span> <span class=s2>&#34;cloudkernels-go-regtoken&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;runner_image&#34;</span><span class=p>:</span> <span class=s2>&#34;harbor.nbfc.io/nubificus/gh-actions-runner-go:final&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;exporter_image&#34;</span><span class=p>:</span> <span class=s2>&#34;harbor.nbfc.io/nubificus/github-actions-runner-metrics:generic&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;node_selector_value&#34;</span><span class=p>:</span> <span class=s2>&#34;cloudkernels/runners&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;runner_exclude_arch&#34;</span><span class=p>:</span> <span class=s2>&#34;arm&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;cpureq&#34;</span><span class=p>:</span> <span class=s2>&#34;200m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;cpulim&#34;</span><span class=p>:</span> <span class=s2>&#34;4000m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;memreq&#34;</span><span class=p>:</span> <span class=s2>&#34;1024Mi&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;memlim&#34;</span><span class=p>:</span> <span class=s2>&#34;8192Mi&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Some interesting points are the following:</p><ul><li>we define resource requests and limits, to make sure we don&rsquo;t starve the bare-metal nodes where these runners are scheduled.</li><li>we customize the container images for the runner and the exporter &ndash; the Docker in Docker part of the runner deployment is used as is.</li><li>we have logic to exclude specific architectures (eg ARM, as for instance go is not supported on aarch32).</li><li>we can define min/max values for the number of runners</li></ul><p>Essentially, via the template shown above and this configuration file, we can
create YAML deployment files dynamically, and apply them to our CI cluster. As
a result, we are presented with a convenient and efficient solution for
adapting CI/CD processes to diverse application needs, enhancing overall
workflow control and efficiency.</p><h3 id=example-ci-pipelines>Example CI pipelines</h3><p>In this section, 2 CI pipeline examples will be presented:</p><ul><li>custom build of runner container images pipeline</li><li>vaccel release pipeline</li></ul><h4 id=example-pipeline-1-build-of-gh-runner-container-images>Example pipeline 1: build of GH runner container images</h4><p>The purpose of this pipeline is to automate the building, tagging and registry uploading of multi-arch containers images used by our custom self-hosted github runners.</p><p>As stated in previous section, we took advantage of docker containers layering functionality and devised a hierarchy tree for our container images. This way we save valuable build time, volume and at the same time satisfy constraints about installation dependencies and conflicts.</p><p>This Dockerfile lineage is depicted in a json file with build_levels, and base Dockerfiles for higher build_levels, Github runner labels to designate execution environments and output tags to mark the manufactured images.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dockerfile_build_components&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;image_filename&#34;</span><span class=p>:</span> <span class=s2>&#34;Dockerfile.gcc-lite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	          <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=s2>&#34;lite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;x86_64&#34;</span><span class=p>,</span> <span class=s2>&#34;aarch64&#34;</span><span class=p>,</span><span class=s2>&#34;armv7l&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;image_filename&#34;</span><span class=p>:</span> <span class=s2>&#34;Dockerfile.rust&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;base_filename&#34;</span> <span class=p>:</span> <span class=s2>&#34;Dockerfile.gcc-lite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	          <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=s2>&#34;lite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;x86_64&#34;</span><span class=p>,</span> <span class=s2>&#34;aarch64&#34;</span><span class=p>,</span><span class=s2>&#34;armv7l&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;output_manifest_tag&#34;</span><span class=p>:</span> <span class=s2>&#34;final&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Dockerfiles have been modified accordingly:</p><p>Dockerfile sample1: gcc-lite base image, derived from the uploaded generic image</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>FROM harbor.nbfc.io/nubificus/gh-actions-runner-base:generic
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ENV <span class=nv>DEBIAN_FRONTEND</span><span class=o>=</span>noninteractive
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SHELL <span class=o>[</span><span class=s2>&#34;/bin/bash&#34;</span>, <span class=s2>&#34;-o&#34;</span>, <span class=s2>&#34;pipefail&#34;</span>, <span class=s2>&#34;-c&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Install base packages.</span>
</span></span><span class=line><span class=cl>USER root
</span></span><span class=line><span class=cl>RUN apt update <span class=o>&amp;&amp;</span> <span class=nv>TZ</span><span class=o>=</span>Etc/UTC <span class=se>\
</span></span></span><span class=line><span class=cl>    apt-get install -y --no-install-recommends <span class=se>\
</span></span></span><span class=line><span class=cl>    gcc <span class=se>\
</span></span></span><span class=line><span class=cl>    g++ <span class=se>\
</span></span></span><span class=line><span class=cl>    curl <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    apt-get -y clean <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    rm -rf /var/cache/apt /var/lib/apt/lists/* /tmp/* /var/tmp/*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Install build-essential and update cmake</span>
</span></span><span class=line><span class=cl>RUN apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    apt-get install -y --no-install-recommends software-properties-common <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    add-apt-repository -y ppa:ubuntu-toolchain-r/test <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    apt-get install -y --no-install-recommends gcc-10 g++-10 <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 <span class=m>100</span> --slave /usr/bin/g++ g++ /usr/bin/g++-10 <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    apt-get install -y --no-install-recommends build-essential cmake protobuf-compiler protobuf-c-compiler libclang-dev <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    apt-get -y clean <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    rm -rf /var/cache/apt /var/lib/apt/lists/* /tmp/* /var/tmp/*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>USER runner
</span></span><span class=line><span class=cl>ENTRYPOINT <span class=o>[</span><span class=s2>&#34;/entrypoint.sh&#34;</span><span class=o>]</span>
</span></span></code></pre></div><p>Dockerfile sample2: Rust dockerfile -just adds rust installation in the base image created for level0</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>FROM nubificus_base_build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>USER root
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Install rust using rustup</span>
</span></span><span class=line><span class=cl>ENV <span class=nv>RUSTUP_HOME</span><span class=o>=</span>/opt/rust <span class=nv>CARGO_HOME</span><span class=o>=</span>/opt/cargo <span class=nv>PATH</span><span class=o>=</span>/opt/cargo/bin:<span class=nv>$PATH</span>
</span></span><span class=line><span class=cl>RUN wget --https-only --secure-protocol<span class=o>=</span>TLSv1_2 -O- https://sh.rustup.rs <span class=p>|</span> sh /dev/stdin -y
</span></span><span class=line><span class=cl>RUN chmod a+w /opt/cargo
</span></span><span class=line><span class=cl>RUN chmod a+w /opt/rust
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>USER runner
</span></span><span class=line><span class=cl>ENTRYPOINT <span class=o>[</span><span class=s2>&#34;/entrypoint.sh&#34;</span><span class=o>]</span>
</span></span></code></pre></div><p>Individual multi-arch images build are tagged and uploaded to Organization private registry as parts of a manifest list. This way a transparent mechanism is created to distribute from our private registry the correct architecture image per tag.</p><p>Figure 3 presents a sample execution of the pipeline described in our example:</p><ul><li>gcc-lite docker image is build for 3 architectures and uploaded under a specific tag</li><li>rust docker image is then build, based on the previous step gcc-lite tagged image</li><li>setup and cleanup jobs in the beginning and at the end of the pipeline</li></ul><p><figure id=figure-figure-3-sample-execution-pipeline-of-a-2-layer-dependent-container-images><div class="d-flex justify-content-center"><div class=w-100><img src=/images/images/DockerImages_pipeline_capture.png alt="Figure 3: Sample execution pipeline of a 2 layer-dependent container images" loading=lazy data-zoomable></div></div><figcaption>Figure 3: Sample execution pipeline of a 2 layer-dependent container images</figcaption></figure></p><h4 id=example-pipeline-2-vaccel-framework-build-and-release-pipeline>Example pipeline 2: vAccel framework build and release pipeline</h4><p>The purpose of this pipeline is to build a release of vAccel framework. In general, vAccel framework consists of three main set of components: the frontend driver, the backend driver and the runtime components.</p><p>The main characteristics of the Vaccel framework building pipeline are:</p><ul><li><strong>Configurability</strong>: Build & release parameters and build elements details are all described in the manifest.json</li><li><strong>Modularity</strong>: Reusable workflow modules based either on the artifact registry type (ex. s3) from where artifacts are collected or components source code builders before incorporated in the vaccel framework package.</li><li><strong>Dependency orchestration</strong>: Dependent component build stages are fulfilled according to the ascending build level values declared for each component in the manifest.json file</li><li><strong>Runtime variables ephemeral storage</strong>: To accommodate runtime information exchange, we devised a mechanism based on GitHub Actions variables REST API.</li><li><strong>Multi-arch build outputs</strong>:</li></ul><h5 id=configurability>Configurability</h5><p>To ensure that necessary configurations for build&amp;release are stored & maintained in a single location, a declarative manifest json file is used as a single point of truth. It depicts all vAccel framework components details: build level dependencies, release-related information, workflow execution parameters etc.</p><p>Find below a sample manifest.json file</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;v0.6.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;package_registry&#34;</span><span class=p>:</span> <span class=s2>&#34;https://s3.nbfc.io/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;package_registry_location&#34;</span><span class=p>:</span> <span class=s2>&#34;nbfc-assets/vaccel-release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;x86_64&#34;</span><span class=p>,</span> <span class=s2>&#34;aarch64&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;build_type&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;Debug&#34;</span><span class=p>,</span> <span class=s2>&#34;Release&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dry_run&#34;</span><span class=p>:</span> <span class=s2>&#34;false&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nt>&#34;build&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;repo_dependencies&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;repository&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vaccelrt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;package_path&#34;</span><span class=p>:</span> <span class=s2>&#34;artifacts/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;registry&#34;</span><span class=p>:</span> <span class=s2>&#34;https://github.com/cloudkernels/vaccelrt.git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;artifact_registry_path&#34;</span><span class=p>:</span> <span class=s2>&#34;nbfc-assets/vaccel-release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;branch&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;repository&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vaccelrt-torch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;package_path&#34;</span><span class=p>:</span> <span class=s2>&#34;artifacts/opt/share/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;registry&#34;</span><span class=p>:</span> <span class=s2>&#34;https://github.com/nubificus/vaccelrt-plugin-torch.git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;artifact_registry_path&#34;</span><span class=p>:</span> <span class=s2>&#34;nbfc-assets/vaccel-release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;branch&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;runner_tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;torch&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span>                
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;repository&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vaccelrt-jetson&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;package_path&#34;</span><span class=p>:</span> <span class=s2>&#34;artifacts/opt/share/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;registry&#34;</span><span class=p>:</span> <span class=s2>&#34;https://github.com/nubificus/vaccelrt-plugin-jetson.git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;artifact_registry_path&#34;</span><span class=p>:</span> <span class=s2>&#34;nbfc-assets/vaccel-release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;branch&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;runner_tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;jetson&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span>                
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;repository&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vaccelrt-vsock&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;package_path&#34;</span><span class=p>:</span> <span class=s2>&#34;artifacts/opt/lib/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;registry&#34;</span><span class=p>:</span> <span class=s2>&#34;https://github.com/nubificus/vaccelrt-plugin-vsock.git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;artifact_registry_path&#34;</span><span class=p>:</span> <span class=s2>&#34;nbfc-assets/vaccel-release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;branch&#34;</span><span class=p>:</span> <span class=s2>&#34;master&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;runner_tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;rust&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;repository&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vaccelrt-agent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;package_path&#34;</span><span class=p>:</span> <span class=s2>&#34;artifacts/opt/bin/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;registry&#34;</span><span class=p>:</span> <span class=s2>&#34;https://github.com/nubificus/vaccelrt-agent.git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;artifact_registry_path&#34;</span><span class=p>:</span> <span class=s2>&#34;nbfc-assets/vaccel-release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;branch&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;runner_tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;rust&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;repository&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vaccelrt-tensorflow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;package_path&#34;</span><span class=p>:</span> <span class=s2>&#34;artifacts/opt/share/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;registry&#34;</span><span class=p>:</span> <span class=s2>&#34;https://github.com/nubificus/vaccelrt-plugin-tensorflow.git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;artifact_registry_path&#34;</span><span class=p>:</span> <span class=s2>&#34;nbfc-assets/vaccel-release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;branch&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;runner_tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;tf&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span>                
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;repository&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vaccelrt-pynq&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;package_path&#34;</span><span class=p>:</span> <span class=s2>&#34;artifacts/opt/lib/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;registry&#34;</span><span class=p>:</span> <span class=s2>&#34;https://github.com/nubificus/vaccelrt-plugin-pynq.git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;artifact_registry_path&#34;</span><span class=p>:</span> <span class=s2>&#34;nbfc-assets/vaccel-release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;branch&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;runner_tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;gcc&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;build_level&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>                     
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;artifact_dependencies&#34;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h5 id=modularity>Modularity</h5><p>vAccel framework is comprised of three main component sets (frontend driver, the backend driver and the runtime components) so we decided that a modular design suits best for our vAccel framework build & release pipeline.</p><p>A multi-level set of reusable workflows was implemented based on the following high level abstract design:</p><pre>

    preprocessor.yml --- processor.yml (top level)
                          |
                          ------- level1_artifacts-collect.yml
                          |       |
                          |       ---- level2_artifact_a.yaml
                          |       ---- level2_artifact_b.yaml                     
                          |
                          ------- level1_components-build.yml
                                  |
                                  ---- level2-component-build_a.yaml
                                  ---- level2-component-build_b.yaml
                                  ---- level2-component-build_c.yaml
 </pre><p>This modular design enables to add new runtime components with minimum development modifications in existing workflow code, as well as ensures that these modifications are isolated from code building other components reducing significantly the risk of regressions.</p><h5 id=dependency-orchestration>Dependency orchestration</h5><p>To successfully build vAccel framework, several build dependencies between components must be met. To get along with these build dependencies, we devised a multi-stage building process. Building dependencies are declared per build target inside the manifest.json using the &ldquo;build_level&rdquo; field. Up to now 2 building levels are implemented: build_level &ldquo;0&rdquo; and build_level &ldquo;1&rdquo; -more could be added, if necessary.</p><p>Building of components with lower build_level precede building of components with higher build_level: higher build levels components are build only after lower level builds have completed. This way higher level components can use dependency artifacts built in previous workflow steps to build successfully.</p><p>Dependencies are calculated in the initial processor workflow steps: a strategy matrix is produced for each build level with the respective components only and two dependent build jobs are then invoked for each strategy matrix created.</p><p>Each component is build according to its own callable workflow build file and building is executed in specific self-hosted github runners as per manifest component &ldquo;runner_tag&rdquo; information. Then components are uploaded to the location designated inside the component section of the manifest.json file, ready to be used at the later stage. Building information is stored using a runtime
ephemeral mechanism based on GitHub Actions variables REST API.</p><h5 id=runtime-variables-ephemeral-storage>Runtime variables ephemeral storage</h5><p>As already mentioned, in vAccel framework there exist various components with building dependencies to other components. In order to make components with lower build level (build previously in the same github workflow execution) available to higher build level components, we had to overcome a github actions constraint: there is no way -up to now- to exchange information between dynamically spawned github action jobs or between a static job and dependent dynamic github action jobs.</p><p>To overcome this constraint, we devised a mechanism that takes advantage of the GitHub Actions variables REST API: each job creates repository variables that store runtime information: remote registry path where the build output was uploaded, the build step status etc. Variables are created using a unique template naming convention: it is a combination of the component name, target architecture and github unique github action run_id. This way, jobs executed at a later stage of the building execution can access specific variables and their information. To store multiple sections of information in a single variable, the value of the repository github variable created is a meaningful json structure. This way value can be easily read, updated or manipulated.</p><p>Figures 4 and 5 show the relevant examples.</p><p><figure id=figure-figure-4-example-of-a-repository-variable-uploaded-build-artifact-remote-path><div class="d-flex justify-content-center"><div class=w-100><img src=/images/images/vAccel_gh_variables_capture.png alt="Figure 4: Example of a repository variable: uploaded build artifact remote path" loading=lazy data-zoomable></div></div><figcaption>Figure 4: Example of a repository variable: uploaded build artifact remote path</figcaption></figure></p><p><figure id=figure-figure-5-example-of-a-repository-variable-build-job-status><div class="d-flex justify-content-center"><div class=w-100><img src=/images/images/vAccel_gh_variables_capture2.png alt="Figure 5: Example of a repository variable: build job status" loading=lazy data-zoomable></div></div><figcaption>Figure 5: Example of a repository variable: build job status</figcaption></figure></p><h5 id=multi-arch-build-outputs>Multi-arch build outputs</h5><p>vAccel is a multi-arch framework: it supports <code>x86_64</code>, <code>aarch64</code> & <code>armv7l</code> architectures. To build vAccel framework for multiple architectures builds have to run on specific spawned Github self-hosted runners with the same architecture. As presented in the previous section of this post, a mechanism was improvised that builds, tags and uploads multi-arch docker images under a single docker label to our private registry.</p><p>Self-hosted runners with custom build and tagged images are spawned in our kubernetes ecosystem so that components can build using these runners.</p><p>vAccel framework build and release pipeline sets the same &ldquo;runs-on&rdquo; policies for the component build jobs: this way jobs are executed only on spawned runners matching the set of the requested tags.</p><h5 id=packaging-and-release>Packaging and release</h5><p>After component building is completed successfully, the finalizing steps of the vAccel framework packaging takes place: components are downloaded from their previously uploaded locations, release type is calculated & released vAccel framework package is uploaded.</p><p>Release type is calculated (SNAPSHOT, RC, Release) according to the triggering github event details:</p><table><thead><tr><th style=text-align:center>Github Actions trigger</th><th style=text-align:center>vAccel Framework Release Type</th></tr></thead><tbody><tr><td style=text-align:center>Pull requests to main branch</td><td style=text-align:center>RC (Release Candidate)</td></tr><tr><td style=text-align:center>Push trigger to main branch</td><td style=text-align:center>Release</td></tr><tr><td style=text-align:center>All other cases (ex. manual execution)</td><td style=text-align:center>SNAPSHOT</td></tr></tbody></table><p>Figure 6 captures the high level execution diagram of a sample execution of the pipeline described in our example:</p><ul><li>Preparatory actions</li><li>2-level building of components</li><li>fetching built components & final packaging vAccel framework release</li></ul><p><figure id=figure-figure-6-high-level-execution-diagram-of-vaccel-framework-build-pipeline><div class="d-flex justify-content-center"><div class=w-100><img src=/images/images/vAccel_build_pipeline_capture.png alt="Figure 6: High Level execution diagram of vAccel framework build pipeline" loading=lazy data-zoomable></div></div><figcaption>Figure 6: High Level execution diagram of vAccel framework build pipeline</figcaption></figure></p></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=%2Fblog%2Fgar_k8s%2F&amp;text=Build+Multi-arch+CI+pipelines+with+Github+Actions+Self-hosted+Runners" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=%2Fblog%2Fgar_k8s%2F&amp;t=Build+Multi-arch+CI+pipelines+with+Github+Actions+Self-hosted+Runners" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Build%20Multi-arch%20CI%20pipelines%20with%20Github%20Actions%20Self-hosted%20Runners&amp;body=%2Fblog%2Fgar_k8s%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=%2Fblog%2Fgar_k8s%2F&amp;title=Build+Multi-arch+CI+pipelines+with+Github+Actions+Self-hosted+Runners" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Build+Multi-arch+CI+pipelines+with+Github+Actions+Self-hosted+Runners%20%2Fblog%2Fgar_k8s%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=%2Fblog%2Fgar_k8s%2F&amp;title=Build+Multi-arch+CI+pipelines+with+Github+Actions+Self-hosted+Runners" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div></div></article><script>function blogGoBack(){document.referrer&&document.referrer.indexOf("/blog")!==-1?history.back():window.location.href="/blog/"}</script></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text"> 2026 Nubificus LTD. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target=_blank rel=noopener>Hugo Blox Builder</a>  the free, <a href=https://github.com/HugoBlox/hugo-blox-builder target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.6782e3f6a4f06ea4766df038c45ecf40.js></script><script src=https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js integrity crossorigin=anonymous></script><script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.b95a7e109243f29d04930ae8cb49a756.js type=module></script><script src=/en/js/wowchemy.min.ed487406ecbb80985462ba7a97b6f2d2.js></script><script src=/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js type=module></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy
</a><a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.9c0e895144aef5a693008b5c5d450147.js type=module></script></body></html>