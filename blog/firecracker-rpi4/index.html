<!doctype html><!-- This site was created with Hugo Blox. https://hugoblox.com --><!-- Last Published: February 20, 2026 --><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo Blox Builder 5.9.7"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/css/vendor-bundle.min.26c458e6907dc03073573976b7f4044e.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css integrity crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=/css/wowchemy.1aac88f67649a5938f00c9b82441a209.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><script async src="https://www.googletagmanager.com/gtag/js?id=G-KSC25ZE341"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","G-KSC25ZE341",{anonymize_ip:!0}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><meta name=author content="Charalampos Mainas"><meta name=description content="Since we got our hands on the new Raspberry Pi 4, we started exploring how
various virtualization technologies behave on the board. First thing we tried is how to run Nabla on it and how it compares to native KVM."><link rel=alternate hreflang=en-us href=/blog/firecracker-rpi4/><link rel=canonical href=/blog/firecracker-rpi4/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu_997e0522978c46c6.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu_409bdbda4e241619.png><meta name=theme-color content="#1565c0"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@nubificus"><meta property="twitter:creator" content="@nubificus"><meta property="twitter:image" content="/media/logo_hu_866fdf07312224c.png"><meta property="og:type" content="website"><meta property="og:site_name" content="Nubificus"><meta property="og:url" content="/blog/firecracker-rpi4/"><meta property="og:title" content="Porting Firecracker to a Raspberry Pi 4 | Nubificus"><meta property="og:description" content="Since we got our hands on the new Raspberry Pi 4, we started exploring how
various virtualization technologies behave on the board. First thing we tried is how to run Nabla on it and how it compares to native KVM."><meta property="og:image" content="/media/logo_hu_866fdf07312224c.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2019-10-21T09:58:31+02:00"><meta property="article:modified_time" content="2019-10-21T09:58:31+02:00"><script src=https://cdn.jsdelivr.net/gh/osano/cookieconsent@3.1.1/build/cookieconsent.min.js integrity="sha512-yXXqOFjdjHNH1GND+1EO0jbvvebABpzGKD66djnUfiKlYME5HGMUJHoCaeE4D5PTG2YsSJf6dwqyUUvQvS0vaA==" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/osano/cookieconsent@3.1.1/build/cookieconsent.min.css integrity="sha512-LQ97camar/lOliT/MqjcQs5kWgy6Qz/cCRzzRzUCfv0fotsCTC9ZHXaPQmJV8Xu/PVALfJZ7BDezl5lW3/qBxg==" crossorigin=anonymous><script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#1565c0",text:"rgb(255, 255, 255)"},button:{background:"rgb(255, 255, 255)",text:"#1565c0"}},theme:"classic",content:{message:"This website uses cookies to ensure you get the best experience on our website.",dismiss:"Got it!",link:"Learn more",href:"https://www.cookiesandyou.com"}})})</script><title>Porting Firecracker to a Raspberry Pi 4 | Nubificus</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=3db308c99747ad92f9b214482636b60a><script src=/js/wowchemy-init.min.9e4214442a7711d35691acd58f6f6361.js></script><div class="page-header header--fixed"><style>.navbar-logo img{max-height:45px;width:auto;display:block}.navbar-logo .logo-dark{display:none}body.colorscheme-dark .navbar-logo .logo-light,body.dark .navbar-logo .logo-light{display:none}body.colorscheme-dark .navbar-logo .logo-dark,body.dark .navbar-logo .logo-dark{display:block}.navbar-logo.logo-nubis,.navbar-logo.logo-nubificus{display:none}</style><script>document.addEventListener("DOMContentLoaded",function(){var e=window.location.hostname,t=e==="nubis-pc.eu"||e==="www.nubis-pc.eu",n=t?"logo-nubis":"logo-nubificus";document.querySelectorAll(".navbar-logo."+n).forEach(function(e){e.style.display="flex"}),document.querySelectorAll("[data-brand]").forEach(function(e){var n=e.getAttribute("data-brand");t?e.textContent=n==="primary"?"Nubis":"Nubificus":e.textContent=n==="primary"?"Nubificus":"Nubis"})})</script><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/><div class="navbar-logo logo-nubificus"><img class=logo-light src=/media/logo-nubificus_hu_7be4fa6b19286a64.png alt=Nubificus>
<img class=logo-dark src=/media/logo-nubificus-dark_hu_bd80a6d6121ee2ff.png alt=Nubificus></div><div class="navbar-logo logo-nubis"><img class=logo-light src=/media/logo-nubis.png alt="Nubis PC">
<img class=logo-dark src=/media/logo-nubis-dark.png alt="Nubis PC"></div></a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/><div class="navbar-logo logo-nubificus"><img class=logo-light src=/media/logo-nubificus_hu_7be4fa6b19286a64.png alt=Nubificus>
<img class=logo-dark src=/media/logo-nubificus-dark_hu_bd80a6d6121ee2ff.png alt=Nubificus></div><div class="navbar-logo logo-nubis"><img class=logo-light src=/media/logo-nubis.png alt="Nubis PC">
<img class=logo-dark src=/media/logo-nubis-dark.png alt="Nubis PC"></div></a></div><div class="navbar-collapse main-menu-item collapse justify-content-end" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/><span>Home</span></a></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Research</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/projects/><span>Projects</span></a>
<a class=dropdown-item href=/publication><span>Publications</span></a></div></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Solutions</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/solutions/edgelink/><span>edgeLink</span></a>
<a class=dropdown-item href=/solutions/urunc/><span>urunc</span></a>
<a class=dropdown-item href=/solutions/vaccel/><span>vAccel</span></a></div></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Feed</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/post><span>News</span></a>
<a class=dropdown-item href=/event><span>Events</span></a></div></li><li class=nav-item><a class="nav-link active" href=/blog><span>Blog</span></a></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>About</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/people><span>People</span></a>
<a class=dropdown-item href=/contact><span>Contact</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span>
</a><a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span>
</a><a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header><script>document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll(".navbar-nav .nav-item.dropdown");e.forEach(function(t){t.addEventListener("mouseenter",function(){e.forEach(function(e){if(e!==t){e.classList.remove("show");var n=e.querySelector(".dropdown-menu");n&&n.classList.remove("show")}}),t.classList.add("show");var n=t.querySelector(".dropdown-menu");n&&n.classList.add("show")}),t.addEventListener("mouseleave",function(){t.classList.remove("show");var e=t.querySelector(".dropdown-menu");e&&e.classList.remove("show")})})})</script></div><div class=page-body><article class=article><div class=article-container><a class=blog-back-link href=javascript:void(0) onclick=blogGoBack()><i class="fas fa-arrow-left"></i> Back to Blog</a></div><div class="article-container pt-3"><h1>Porting Firecracker to a Raspberry Pi 4</h1><div class=article-metadata><span class=article-date>Oct 21, 2019</span></div></div><div class=article-container><div class=article-style><p>Since we got our hands on the new Raspberry Pi 4, we started exploring how
various virtualization technologies behave on the board. First thing we tried is how to run <a href=https://cloudkernels.github.io/posts/rpi4-64bit-virt/ target=_blank rel=noopener>Nabla</a> on it and how it compares to native KVM.</p><p>Next thing we wanted to try is <a href=https://github.com/firecracker-microvm/firecracker target=_blank rel=noopener>firecracker</a>, the notorious micro-VMM that
Amazon Lambda & Fargate run on. To our disappointment, firecracker was not
<a href=https://github.com/firecracker-microvm/firecracker/issues/1196 target=_blank rel=noopener>yet</a> running on RPi4. So we started looking into coding in the necessary
changes :)</p><p>After a bit of investigation, we figured out that the key missing piece is
support for the GICv2 ARM interrupt controller. In fact, firecracker only
supports GIC version 3 since it was open-sourced, but not version 2, which is
the version appearing in the Raspberry Pi series, as well as in other popular
boards, like the Hikey 970 we got our hands on, or Khadas VIM3. A bit more
digging into the internals of firecracker and the Linux kernel, helped us
work out the details and open a <a href=https://github.com/firecracker-microvm/firecracker/pull/1235 target=_blank rel=noopener>pull-request</a> which adds support for the
missing parts.</p><h4 id=changes-in-firecracker>Changes in Firecracker</h4><p>The Generic Interrupt Controller (GIC) is the IP block in the ARM processors
that implements interrupt handling. The Linux kernel supports user- and
kernel-space emulation for GICv2 as well as GICv3 and v4. However, Firecracker
only handles the GICv3-related configuration of the virtual GIC (VGIC).
Similarly, setting up the FDT for the guest microVM from Firecracker only
handles GIC-v3 devices.</p><p>In terms of code organization, the GIC related code currently exposes a function
for setting up GICv3 performing the corresponding <code>ioctl</code> KVM commands. The
first part of our PR changes this by introducing a GIC Trait which defines the
common interface for all GIC implementations. Even though it is still under
discussion, what exactly will be in the Trait in its final form, it will be
something along the following lines:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=sd>/// Trait for GIC devices.
</span></span></span><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>trait</span><span class=w> </span><span class=n>GICDevice</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Returns the GIC version of the device
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>version</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>u32</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Returns the file descriptor of the GIC device
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>device_fd</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>DeviceFd</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Returns an array with GIC device properties
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>device_properties</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u64</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>With this in place, we can define objects per GIC version, which implement this
Trait, and still have the rest of the code deal with the <code>GICDevice</code> Trait,
which is transparent to the GIC version.</p><p>The implementations for each version, implement the Trait and a <code>new</code> function
which is used to create the new object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>vm</span>: <span class=kp>&amp;</span><span class=nc>VmFd</span><span class=p>,</span><span class=w> </span><span class=n>vcpu_count</span>: <span class=kt>u64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=nb>Box</span><span class=o>&lt;</span><span class=n>GICDevice</span><span class=o>&gt;&gt;</span><span class=w>
</span></span></span></code></pre></div><p>The differentiation between the two versions lays in the VGIC register
attributes that each device exposes. As a result, the work we need to do is essentially to <code>mmap</code> their addresses.</p><p>GICv2 relevant addresses include the <strong>distributor</strong> and <strong>cpu</strong> groups:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=cm>/* Setting up the distributor attribute.
</span></span></span><span class=line><span class=cl><span class=cm> We are placing the GIC below 1GB so we need to substract the size of the distributor.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>set_device_attribute</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&amp;</span><span class=n>vgic_fd</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>kvm_bindings</span>::<span class=no>KVM_DEV_ARM_VGIC_GRP_ADDR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>u64</span>::<span class=n>from</span><span class=p>(</span><span class=n>kvm_bindings</span>::<span class=no>KVM_VGIC_V2_ADDR_TYPE_DIST</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&amp;</span><span class=n>get_dist_addr</span><span class=p>()</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u64</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=cm>/* Setting up the CPU attribute.
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>set_device_attribute</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&amp;</span><span class=n>vgic_fd</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>kvm_bindings</span>::<span class=no>KVM_DEV_ARM_VGIC_GRP_ADDR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>u64</span>::<span class=n>from</span><span class=p>(</span><span class=n>kvm_bindings</span>::<span class=no>KVM_VGIC_V2_ADDR_TYPE_CPU</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&amp;</span><span class=n>get_cpu_addr</span><span class=p>()</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u64</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>whereas the GICv3 includes the <strong>distributor</strong> and <strong>redistributor</strong> groups:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=cm>/* Setting up the distributor attribute.
</span></span></span><span class=line><span class=cl><span class=cm> We are placing the GIC below 1GB so we need to substract the size of the distributor.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>set_device_attribute</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&amp;</span><span class=n>vgic_fd</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>kvm_bindings</span>::<span class=no>KVM_DEV_ARM_VGIC_GRP_ADDR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>u64</span>::<span class=n>from</span><span class=p>(</span><span class=n>kvm_bindings</span>::<span class=no>KVM_VGIC_V3_ADDR_TYPE_DIST</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&amp;</span><span class=n>get_dist_addr</span><span class=p>()</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u64</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=cm>/* Setting up the redistributors&#39; attribute.
</span></span></span><span class=line><span class=cl><span class=cm>We are calculating here the start of the redistributors address. We have one per CPU.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>set_device_attribute</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&amp;</span><span class=n>vgic_fd</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>kvm_bindings</span>::<span class=no>KVM_DEV_ARM_VGIC_GRP_ADDR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>u64</span>::<span class=n>from</span><span class=p>(</span><span class=n>kvm_bindings</span>::<span class=no>KVM_VGIC_V3_ADDR_TYPE_REDIST</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&amp;</span><span class=n>get_redists_addr</span><span class=p>(</span><span class=kt>u64</span>::<span class=n>from</span><span class=p>(</span><span class=n>vcpu_count</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u64</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Finally, for both versions of GIC we finalize the device initialization by
setting the number of supported interrupts and the <em>control_init</em> group.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=sd>/// Finalize the setup of a GIC device
</span></span></span><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>finalize_device</span><span class=p>(</span><span class=n>fd</span>: <span class=kp>&amp;</span><span class=nc>DeviceFd</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* We need to tell the kernel how many irqs to support with this vgic.
</span></span></span><span class=line><span class=cl><span class=cm>     * See the `layout` module for details.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>nr_irqs</span>: <span class=kt>u32</span> <span class=o>=</span><span class=w> </span><span class=k>super</span>::<span class=n>layout</span>::<span class=no>IRQ_MAX</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>super</span>::<span class=n>layout</span>::<span class=no>IRQ_BASE</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>nr_irqs_ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>nr_irqs</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u32</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>set_device_attribute</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fd</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>kvm_bindings</span>::<span class=no>KVM_DEV_ARM_VGIC_GRP_NR_IRQS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>nr_irqs_ptr</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* Finalize the GIC.
</span></span></span><span class=line><span class=cl><span class=cm>     * See https://code.woboq.org/linux/linux/virt/kvm/arm/vgic/vgic-kvm-device.c.html#211.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>set_device_attribute</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fd</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>kvm_bindings</span>::<span class=no>KVM_DEV_ARM_VGIC_GRP_CTRL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>u64</span>::<span class=n>from</span><span class=p>(</span><span class=n>kvm_bindings</span>::<span class=no>KVM_DEV_ARM_VGIC_CTRL_INIT</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Regarding the FDT creation, there are differences between v2 and v3 regarding
the interrupt controller <code>intc</code> node.</p><p>First, we need to define the GICv2 <code>compatible</code> property to be <code>arm,gic-400</code>,
since it is the GIC-400 chip which implements GICv2. Next is the <code>reg</code>
property of the FDT, which includes the addresses and the corresponding sizes of
the GIC registers, i.e. distributor and CPU for GICv2, distributor and
redistributor for GICv3. Finally, we fix the <code>interrupts</code> property which
determines the interrupt source of the VGIC maintenance interrupt. The
corresponding values for GICv2 were taken from the respective <a href=https://github.com/torvalds/linux/blob/master/Documentation/devicetree/bindings/interrupt-controller/arm%2Cgic.yaml target=_blank rel=noopener>Linux Kernel entries</a>.</p><h4 id=build-firecracker-with-rpi4-support>Build firecracker with RPi4 support</h4><p>While waiting for the patch to merge upstream you can go ahead and check out it
yourself.</p><p>Clone and build our fork of firecracker (keep in mind that while the PR review
is going on, we might force-update the branch).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ git clone https://github.com/cloudkernels/firecracker.git
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> firecracker
</span></span><span class=line><span class=cl>$ ./tools/devtool build
</span></span></code></pre></div><p>Next you need a kernel image and a root filesystem to run with your firecracker
build. You can grab the pre-built kernel image and rootfs here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ wget https://s3.amazonaws.com/spec.ccfc.min/img/aarch64/ubuntu_with_ssh/kernel/vmlinux.bin
</span></span><span class=line><span class=cl>$ wget https://s3.amazonaws.com/spec.ccfc.min/img/aarch64/ubuntu_with_ssh/fsfiles/xenial.rootfs.ext4 
</span></span></code></pre></div><p>Alternatively, you can build your own kernel and rootfs using the following
steps provided by the firecracker docs
<a href=https://github.com/cloudkernels/firecracker/blob/master/docs/rootfs-and-kernel-setup.md target=_blank rel=noopener>here</a></p><h4 id=launch-our-image>Launch our image</h4><p>To launch our image we will use the <a href=https://github.com/firecracker-microvm/firectl target=_blank rel=noopener>firectl</a> tool. We need, to setup a tap
device for the networking or our firecracker microVM.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo ip tuntap add dev tap0 mode tap
</span></span><span class=line><span class=cl>$ sudo ip addr add 172.16.0.1/24 dev tap0
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> tap0 up
</span></span></code></pre></div><p>And we launch the microVM using firectl:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>firectl --firecracker-binary<span class=o>=</span><span class=si>${</span><span class=nv>PATH_TO_FC_BIN</span><span class=si>}</span> --kernel<span class=o>=</span>vmlinux.bin <span class=se>\
</span></span></span><span class=line><span class=cl>	--tap-device<span class=o>=</span>tap0/aa:fc:00:00:00:01 <span class=se>\
</span></span></span><span class=line><span class=cl>	--kernel-opts<span class=o>=</span><span class=s2>&#34;console=ttyS0 reboot=k panic=1 pci=off ip=172.16.0.42::172.16.0.1:255.255.255.0::eth0:off&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>	--root-drive<span class=o>=</span>./nginx_fc.ext4
</span></span></code></pre></div><p>Here, we used here the <code>ip</code> kernel boot parameter to give the <code>172.16.0.42</code>.</p><p>Finally, we try out our nginx server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>curl 172.16.0.42
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Welcome to nginx!<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>body</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>width</span><span class=p>:</span> <span class=mi>35</span><span class=kt>em</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span> <span class=kc>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>font-family</span><span class=p>:</span> <span class=n>Tahoma</span><span class=p>,</span> <span class=n>Verdana</span><span class=p>,</span> <span class=n>Arial</span><span class=p>,</span> <span class=kc>sans-serif</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Welcome to nginx!<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>If you see this page, the nginx web server is successfully installed and
</span></span><span class=line><span class=cl>working. Further configuration is required.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>For online documentation and support please refer to
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://nginx.org/&#34;</span><span class=p>&gt;</span>nginx.org<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>.<span class=p>&lt;</span><span class=nt>br</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>Commercial support is available at
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://nginx.com/&#34;</span><span class=p>&gt;</span>nginx.com<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>em</span><span class=p>&gt;</span>Thank you for using nginx.<span class=p>&lt;/</span><span class=nt>em</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div></div><div class=article-tags><a class="badge badge-light" href=/tag/raspberry-pi/>Raspberry Pi</a>
<a class="badge badge-light" href=/tag/firecracker/>Firecracker</a>
<a class="badge badge-light" href=/tag/gic/>GIC</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=%2Fblog%2Ffirecracker-rpi4%2F&amp;text=Porting+Firecracker+to+a+Raspberry+Pi+4" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=%2Fblog%2Ffirecracker-rpi4%2F&amp;t=Porting+Firecracker+to+a+Raspberry+Pi+4" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Porting%20Firecracker%20to%20a%20Raspberry%20Pi%204&amp;body=%2Fblog%2Ffirecracker-rpi4%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=%2Fblog%2Ffirecracker-rpi4%2F&amp;title=Porting+Firecracker+to+a+Raspberry+Pi+4" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Porting+Firecracker+to+a+Raspberry+Pi+4%20%2Fblog%2Ffirecracker-rpi4%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=%2Fblog%2Ffirecracker-rpi4%2F&amp;title=Porting+Firecracker+to+a+Raspberry+Pi+4" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div></div></article><script>function blogGoBack(){document.referrer&&document.referrer.indexOf("/blog")!==-1?history.back():window.location.href="/blog/"}</script></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">© 2026 Nubificus LTD. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target=_blank rel=noopener>Hugo Blox Builder</a> — the free, <a href=https://github.com/HugoBlox/hugo-blox-builder target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.6782e3f6a4f06ea4766df038c45ecf40.js></script><script src=https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js integrity crossorigin=anonymous></script><script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.b95a7e109243f29d04930ae8cb49a756.js type=module></script><script src=/en/js/wowchemy.min.ed487406ecbb80985462ba7a97b6f2d2.js></script><script src=/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js type=module></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy
</a><a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.9c0e895144aef5a693008b5c5d450147.js type=module></script></body></html>