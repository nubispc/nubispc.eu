<!DOCTYPE html>
<!-- This site was created with Hugo Blox. https://hugoblox.com -->
<!-- Last Published: February 16, 2026 --><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Hugo Blox Builder 5.9.7" />
  

  
  












  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.26c458e6907dc03073573976b7f4044e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.b2143a565ef733cce408eccf45aa36ba.css" />

  
  
  

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" >
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" disabled>
  

  
  



























  
  
  






  <meta name="author" content="Charalampos Mainas" />





  

<meta name="description" content="Kubernetes is the de-facto platform to automate the management, deployment, and scaling of containerized applications. One of its strongest features is its ability to scale, allowing users to customize the system according to their needs. A key mechanism for this extensibility is Custom Resource Definitions (CRD)." />



<link rel="alternate" hreflang="en-us" href="/blog/crd/" />
<link rel="canonical" href="/blog/crd/" />



  <link rel="manifest" href="/manifest.webmanifest" />



<link rel="icon" type="image/png" href="/media/icon_hu_ea0c30c6d45d84f4.png" />
<link rel="apple-touch-icon" type="image/png" href="/media/icon_hu_86daab30bf3ca8be.png" />

<meta name="theme-color" content="#1565c0" />










  
  






<meta property="twitter:card" content="summary" />

  <meta property="twitter:site" content="@GetResearchDev" />
  <meta property="twitter:creator" content="@GetResearchDev" />
<meta property="twitter:image" content="/media/logo_hu_f553cb9eef83bc41.png" />



  

<meta property="og:type" content="website" />
<meta property="og:site_name" content="Nubificus" />
<meta property="og:url" content="/blog/crd/" />
<meta property="og:title" content="Kubebuilder: Extending the k8s API to match applications&#39; needs | Nubificus" />
<meta property="og:description" content="Kubernetes is the de-facto platform to automate the management, deployment, and scaling of containerized applications. One of its strongest features is its ability to scale, allowing users to customize the system according to their needs. A key mechanism for this extensibility is Custom Resource Definitions (CRD)." /><meta property="og:image" content="/media/logo_hu_f553cb9eef83bc41.png" /><meta property="og:locale" content="en-us" />

  
    <meta
      property="article:published_time"
      content="2024-11-07T08:02:51&#43;01:00"
    />
  
  
    <meta property="article:modified_time" content="2024-11-07T08:02:51&#43;01:00">
  







  




  
  
  

  
  

  
  
  
  
  
    <script src="https://cdn.jsdelivr.net/gh/osano/cookieconsent@3.1.1/build/cookieconsent.min.js" integrity="sha512-yXXqOFjdjHNH1GND+1EO0jbvvebABpzGKD66djnUfiKlYME5HGMUJHoCaeE4D5PTG2YsSJf6dwqyUUvQvS0vaA==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/osano/cookieconsent@3.1.1/build/cookieconsent.min.css" integrity="sha512-LQ97camar/lOliT/MqjcQs5kWgy6Qz/cCRzzRzUCfv0fotsCTC9ZHXaPQmJV8Xu/PVALfJZ7BDezl5lW3/qBxg==" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#1565c0",
          "text": "rgb(255, 255, 255)"
        },
        "button": {
          "background": "rgb(255, 255, 255)",
          "text": "#1565c0"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://www.cookiesandyou.com"
      }
    })});
  </script>



  
  <title>Kubebuilder: Extending the k8s API to match applications&#39; needs | Nubificus</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="e59570927d976715910cf9e40f95b3a3" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.9e4214442a7711d35691acd58f6f6361.js"></script>

  




  <div class="page-header header--fixed">
  
  
  
  
  


<style>
.navbar-logo {
    height: 50px;
    display: flex;
    align-items: center;
}

.navbar-logo img {
    max-height: 45px;
    width: auto;
    display: block;
}

.navbar-logo .logo-dark {
    display: none;
}

body.colorscheme-dark .navbar-logo .logo-light,
body.dark .navbar-logo .logo-light {
    display: none;
}

body.colorscheme-dark .navbar-logo .logo-dark,
body.dark .navbar-logo .logo-dark {
    display: block;
}

.navbar-logo.logo-nubis,
.navbar-logo.logo-nubificus {
    display: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var host = window.location.hostname;
    var isNubis = (host === 'nubis-pc.eu' || host === 'www.nubis-pc.eu');
    var cls = isNubis ? 'logo-nubis' : 'logo-nubificus';
    document.querySelectorAll('.navbar-logo.' + cls).forEach(function(el) {
        el.style.display = 'flex';
    });
    document.querySelectorAll('[data-brand]').forEach(function(el) {
        var role = el.getAttribute('data-brand');
        if (isNubis) {
            el.textContent = (role === 'primary') ? 'Nubis' : 'Nubificus';
        } else {
            el.textContent = (role === 'primary') ? 'Nubificus' : 'Nubis';
        }
    });
});
</script>










  


<header>
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      
      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">
          <div class="navbar-logo logo-nubificus">
            <img class="logo-light" src="/media/logo-nubificus_hu_5bae3e7b5bc92c43.png" alt="Nubificus">
            <img class="logo-dark" src="/media/logo-nubificus-dark_hu_1887b26263e462ca.png" alt="Nubificus">
          </div>
          <div class="navbar-logo logo-nubis">
            <img class="logo-light" src="/media/logo-nubis.png" alt="Nubis PC">
            <img class="logo-dark" src="/media/logo-nubis-dark.png" alt="Nubis PC">
          </div>
        </a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">
          <div class="navbar-logo logo-nubificus">
            <img class="logo-light" src="/media/logo-nubificus_hu_5bae3e7b5bc92c43.png" alt="Nubificus">
            <img class="logo-dark" src="/media/logo-nubificus-dark_hu_1887b26263e462ca.png" alt="Nubificus">
          </div>
          <div class="navbar-logo logo-nubis">
            <img class="logo-light" src="/media/logo-nubis.png" alt="Nubis PC">
            <img class="logo-dark" src="/media/logo-nubis-dark.png" alt="Nubis PC">
          </div>
        </a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          

          

          
          
          
          

          
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/"><span>Home</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Research</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/projects/"><span>Projects</span></a>
              
                <a class="dropdown-item" href="/publication"><span>Publications</span></a>
              
            </div>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Solutions</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/solutions/edgelink/"><span>edgeLink</span></a>
              
                <a class="dropdown-item" href="/solutions/urunc/"><span>urunc</span></a>
              
                <a class="dropdown-item" href="/solutions/vaccel/"><span>vAccel</span></a>
              
            </div>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Feed</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/post"><span>News</span></a>
              
                <a class="dropdown-item" href="/event"><span>Events</span></a>
              
            </div>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>About</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/people"><span>People</span></a>
              
                <a class="dropdown-item" href="/contact"><span>Contact</span></a>
              
            </div>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        

        
        
        

        
        
        
        <li class="nav-item dropdown theme-dropdown">
          <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="Display preferences">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </a>
          <div class="dropdown-menu">
            <a href="#" class="dropdown-item js-set-theme-light">
              <span>Light</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-dark">
              <span>Dark</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-auto">
              <span>Automatic</span>
            </a>
          </div>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <article class="article">

  













  

  
  
  
<div class="article-container pt-3">
  <h1>Kubebuilder: Extending the k8s API to match applications&#39; needs</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Nov 7, 2024
  </span>
  

  

  

  
  
  
  

  
  

</div>

    





  
</div>



  <div class="article-container">

    <div class="article-style">
      <p>Kubernetes is the de-facto platform to automate the management, deployment, and scaling of containerized applications. One of its strongest features is its ability to scale, allowing users to customize the system according to their needs. A key mechanism for this extensibility is <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources" target="_blank" rel="noopener">Custom Resource Definitions</a> (CRD).</p>
<h2 id="what-are-crds">What are CRDs?</h2>
<p>CRDs allow Kubernetes users to create and manage their own custom resources. A Custom Resource (CR) is essentially a Kubernetes resource that does not exist by default but is defined via a CRD.</p>
<p>In other words, CRDs allow the creation of new resource types that Kubernetes doesn&rsquo;t know about a priori. These resources behave like Kubernetes&rsquo; built-in resources (such as Pods, Services, Deployments), but their structure and functionality are determined by the CRD you create.</p>
<h2 id="how-do-crds-work">How do CRDs Work?</h2>
<p>When we define a CRD, Kubernetes extends its API to handle the new resource type. Once a CRD is registered with the Kubernetes API Server, we can create instances of the custom resource just like we would with native resources. The API server will store these objects in Kubernetes&rsquo; distributed key-value store, etcd, and manage their lifecycle.</p>


















<figure  id="figure-figure-1-generic-k8s-operator">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img src="/images/images/operator.png#center" alt="Figure 1: Generic K8s Operator" loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Figure 1: Generic K8s Operator
    </figcaption></figure>

<p>For example, after defining a MyApp CRD, we can create MyApp resources in our cluster, just like we would create Pods or Deployments. There are tools available to facilitate the definition, setup, and management of CRDs and their accompanying components. Such a tool is <a href="https://github.com/kubernetes-sigs/kubebuilder" target="_blank" rel="noopener">KubeBuilder</a>.</p>
<h2 id="what-is-kubebuilder">What is KubeBuilder?</h2>
<p>Kubebuilder is a powerful framework that makes it easy to build and manage Kubernetes operators and APIs. Developed by the Kubernetes team at Google, it is widely recognized as a popular tool among developers working with Kubernetes.</p>
<h3 id="basic-features">Basic features</h3>
<ol>
<li><strong>Building Operators:</strong> Kubebuilder provides a simple and efficient process for building, deploying, and testing Kubernetes operators.</li>
<li><strong>Building APIs:</strong> With Kubebuilder, users can build custom Kubernetes APIs and resources, allowing them to extend Kubernetes with their own functions and resources.</li>
<li><strong>Based on Go:</strong> Kubebuilder is written in Go and uses Kubernetes&rsquo; Go SDK, providing seamless integration with the Go ecosystem.</li>
</ol>
<p>Now let&rsquo;s dive into the process of creating our first custom Kubernetes controller using KubeBuilder.</p>
<h2 id="creating-custom-kubernetes-controller-with-kubebuilder">Creating Custom Kubernetes Controller with KubeBuilder</h2>
<p>To get hands-on with KubeBuilder, we&rsquo;ll create a custom resource called MyApp. This resource represents a simple application comprising multiple pods. We&rsquo;ll also build a Kubernetes controller to manage the lifecycle of these MyApp instances, ensuring the desired state of your application is maintained within the cluster.</p>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Go version v1.20.0+</li>
<li>Docker version 17.03+.</li>
<li>Access to a Kubernetes v1.11.3+ cluster.</li>
</ul>
<h3 id="installation">Installation</h3>
<p>Let&rsquo;s install KubeBuilder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -L -o kubebuilder &#34;https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)&#34;
</span></span><span class="line"><span class="cl">chmod +x kubebuilder &amp;&amp; sudo mv kubebuilder /usr/local/bin/
</span></span></code></pre></div><h4 id="create-a-project">Create a project</h4>
<p>First, let&rsquo;s create and navigate into a directory for our project. Then, we&rsquo;ll initialize it using KubeBuilder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$PWD</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="nv">$GOPATH</span>
</span></span><span class="line"><span class="cl">mkdir <span class="nv">$GOPATH</span>/operator
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$GOPATH</span>/operator
</span></span><span class="line"><span class="cl">go mod init nbfc.io
</span></span><span class="line"><span class="cl">kubebuilder init --domain<span class="o">=</span>nbfc.io
</span></span></code></pre></div><h4 id="create-a-new-api">Create a new API</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> kubebuilder create api --group application --version v1alpha1 --kind MyApp --image<span class="o">=</span>ubuntu:latest --image-container-command<span class="o">=</span><span class="s2">&#34;sleep,infinity&#34;</span> --image-container-port<span class="o">=</span><span class="s2">&#34;22&#34;</span> --run-as-user<span class="o">=</span><span class="s2">&#34;1001&#34;</span> --plugins<span class="o">=</span><span class="s2">&#34;deploy-image/v1-alpha&#34;</span> --make<span class="o">=</span><span class="nb">false</span>
</span></span></code></pre></div><p>This command creates a new Kubernetes API with these parameters:</p>
<ul>
<li>&ndash;group application: Defines the API group name.</li>
<li>&ndash;version v1alpha1: The API version.</li>
<li>&ndash;kind MyApp: The name of custom resource.</li>
<li>&ndash;image=ubuntu:latest: The default container image to use</li>
<li>&ndash;image-container-port=&ldquo;22&rdquo;: Exposes port 22 on the container</li>
<li>&ndash;run-as-user=&ldquo;1001&rdquo;: Sets the user ID for running the container</li>
<li>&ndash;plugins=&ldquo;deploy-image/v1-alpha&rdquo;: Uses the deploy-image plugin</li>
</ul>
<p>We use these parameters to create a custom resource that includes all necessary deployment settings — such as container image, port, and run-as-user — making it more manageable and production-ready within our Kubernetes environment. By using the deploy-image plugin, we achieve optimal customization for our CR without needing further deployment modifications.</p>
<h4 id="install-the-crds-into-the-cluster">Install the CRDs into the cluster</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make install
</span></span></code></pre></div><p>For quick feedback and code-level debugging, let&rsquo;s run our controller:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make run
</span></span></code></pre></div><h3 id="create-an-application-crd-with-a-custom-controller">Create an Application CRD with a custom controller</h3>
<p>In this section we build an application description as a CRD, along with its
accompanying controller that performs simple operations upon spawning. The
application consists of a couple of pods and the controller creates services
according to the exposed container ports. The rationale is to showcase how easy
it is to define logic that accompanies the spawning of pods.</p>
<p>To create custom pods using the controller, we need to modify the following files:</p>
<ul>
<li><code>myapp_controller.go</code></li>
<li><code>myapp_controller_test.go</code></li>
<li><code>application_v1alpha1_myapp.yaml</code></li>
<li><code>myapp_types.go</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">.
</span></span></span><span class="line"><span class="cl"><span class="go">|-- Dockerfile
</span></span></span><span class="line"><span class="cl"><span class="go">|-- Makefile
</span></span></span><span class="line"><span class="cl"><span class="go">|-- PROJECT
</span></span></span><span class="line"><span class="cl"><span class="go">|-- README.md
</span></span></span><span class="line"><span class="cl"><span class="go">|-- api
</span></span></span><span class="line"><span class="cl"><span class="go">|   `-- v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="go">|       |-- groupversion_info.go
</span></span></span><span class="line"><span class="cl"><span class="go">|       `-- myapp_types.go
</span></span></span><span class="line"><span class="cl"><span class="go">|-- bin
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- controller-gen -&gt; /root/operator/bin/controller-gen-v0.16.1
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- controller-gen-v0.16.1
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- kustomize -&gt; /root/operator/bin/kustomize-v5.4.3
</span></span></span><span class="line"><span class="cl"><span class="go">|   `-- kustomize-v5.4.3
</span></span></span><span class="line"><span class="cl"><span class="go">|-- cmd
</span></span></span><span class="line"><span class="cl"><span class="go">|   `-- main.go
</span></span></span><span class="line"><span class="cl"><span class="go">|-- config
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- crd
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- bases
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |   `-- application.nbfc.io_myapps.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- kustomization.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   `-- kustomizeconfig.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- default
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- kustomization.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- manager_metrics_patch.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   `-- metrics_service.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- manager
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- kustomization.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   `-- manager.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- network-policy
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- allow-metrics-traffic.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   `-- kustomization.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- prometheus
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- kustomization.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   `-- monitor.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |-- rbac
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- kustomization.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- leader_election_role.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- leader_election_role_binding.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- metrics_auth_role.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- metrics_auth_role_binding.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- metrics_reader_role.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- myapp_editor_role.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- myapp_viewer_role.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- role.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   |-- role_binding.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   |   `-- service_account.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|   `-- samples
</span></span></span><span class="line"><span class="cl"><span class="go">|       |-- application_v1alpha1_myapp.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|       `-- kustomization.yaml
</span></span></span><span class="line"><span class="cl"><span class="go">|-- go.mod
</span></span></span><span class="line"><span class="cl"><span class="go">|-- go.sum
</span></span></span><span class="line"><span class="cl"><span class="go">|-- hack
</span></span></span><span class="line"><span class="cl"><span class="go">|   `-- boilerplate.go.txt
</span></span></span><span class="line"><span class="cl"><span class="go">|-- internal
</span></span></span><span class="line"><span class="cl"><span class="go">|   `-- controller
</span></span></span><span class="line"><span class="cl"><span class="go">|       |-- myapp_controller.go
</span></span></span><span class="line"><span class="cl"><span class="go">|       |-- myapp_controller_test.go
</span></span></span><span class="line"><span class="cl"><span class="go">|       `-- suite_test.go
</span></span></span><span class="line"><span class="cl"><span class="go">`-- test
</span></span></span><span class="line"><span class="cl"><span class="go">    |-- e2e
</span></span></span><span class="line"><span class="cl"><span class="go">    |   |-- e2e_suite_test.go
</span></span></span><span class="line"><span class="cl"><span class="go">    |   `-- e2e_test.go
</span></span></span><span class="line"><span class="cl"><span class="go">    `-- utils
</span></span></span><span class="line"><span class="cl"><span class="go">        `-- utils.go
</span></span></span></code></pre></div><h4 id="modify-myapp_controllergo">Modify <code>myapp_controller.go</code></h4>
<p>This file contains the core logic of our custom controller, where we implement the reconciliation logic to manage the lifecycle of MyApp resources. Specifically, the controller logic:</p>
<ul>
<li>Monitors MyApp resources for any changes</li>
<li>Creates, updates, or deletes Pods based on the MyApp specifications</li>
<li>Manages Services to ensure connectivity for the Pods</li>
<li>Handles resource cleanup when MyApp resources are deleted</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">controller</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">apierrors</span> <span class="s">&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;k8s.io/apimachinery/pkg/api/meta&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;k8s.io/apimachinery/pkg/types&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;k8s.io/apimachinery/pkg/util/intstr&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;k8s.io/client-go/tools/record&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">applicationv1alpha1</span> <span class="s">&#34;nbfc.io/api/v1alpha1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ctrl</span> <span class="s">&#34;sigs.k8s.io/controller-runtime&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/controller/controllerutil&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">myappFinalizer</span> <span class="p">=</span> <span class="s">&#34;application.nbfc.io/finalizer&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Definitions to manage status conditions</span>
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">typeAvailableMyApp</span> <span class="p">=</span> <span class="s">&#34;Available&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">typeDegradedMyApp</span>  <span class="p">=</span> <span class="s">&#34;Degraded&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MyAppReconciler reconciles a MyApp object</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">MyAppReconciler</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">client</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Scheme</span>   <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Recorder</span> <span class="nx">record</span><span class="p">.</span><span class="nx">EventRecorder</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:rbac:groups=application.nbfc.io,resources=myapps,verbs=get;list;watch;create;update;patch;delete</span>
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:rbac:groups=application.nbfc.io,resources=myapps/status,verbs=get;update;patch</span>
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:rbac:groups=application.nbfc.io,resources=myapps/finalizers,verbs=update</span>
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:rbac:groups=core,resources=events,verbs=create;patch</span>
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:rbac:groups=core,resources=pods,verbs=get;list;watch;create;update;patch;delete</span>
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Reconcile handles the main logic for creating/updating resources based on the MyApp CR</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">MyAppReconciler</span><span class="p">)</span> <span class="nf">Reconcile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Fetch the MyApp resource</span>
</span></span><span class="line"><span class="cl">         <span class="nx">myapp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">applicationv1alpha1</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;myapp resource not found. Ignoring since object must be deleted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to get myapp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Initialize status conditions if none exist</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">meta</span><span class="p">.</span><span class="nf">SetStatusCondition</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">typeAvailableMyApp</span><span class="p">,</span> <span class="nx">Status</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionUnknown</span><span class="p">,</span> <span class="nx">Reason</span><span class="p">:</span> <span class="s">&#34;Reconciling&#34;</span><span class="p">,</span> <span class="nx">Message</span><span class="p">:</span> <span class="s">&#34;Starting reconciliation&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to update MyApp status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to re-fetch myapp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Add finalizer for cleanup during deletion</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">controllerutil</span><span class="p">.</span><span class="nf">ContainsFinalizer</span><span class="p">(</span><span class="nx">myapp</span><span class="p">,</span> <span class="nx">myappFinalizer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Adding Finalizer for MyApp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">controllerutil</span><span class="p">.</span><span class="nf">AddFinalizer</span><span class="p">(</span><span class="nx">myapp</span><span class="p">,</span> <span class="nx">myappFinalizer</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to add finalizer into the custom resource&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to update custom resource to add finalizer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Handle cleanup if MyApp resource is marked for deletion</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isMyAppMarkedToBeDeleted</span> <span class="o">:=</span> <span class="nx">myapp</span><span class="p">.</span><span class="nf">GetDeletionTimestamp</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">isMyAppMarkedToBeDeleted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">controllerutil</span><span class="p">.</span><span class="nf">ContainsFinalizer</span><span class="p">(</span><span class="nx">myapp</span><span class="p">,</span> <span class="nx">myappFinalizer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Performing Finalizer Operations for MyApp before delete CR&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nx">meta</span><span class="p">.</span><span class="nf">SetStatusCondition</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">typeDegradedMyApp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Status</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionUnknown</span><span class="p">,</span> <span class="nx">Reason</span><span class="p">:</span> <span class="s">&#34;Finalizing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Message</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Performing finalizer operations for the custom resource: %s &#34;</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to update MyApp status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nx">r</span><span class="p">.</span><span class="nf">doFinalizerOperationsForMyApp</span><span class="p">(</span><span class="nx">myapp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to re-fetch myapp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nx">meta</span><span class="p">.</span><span class="nf">SetStatusCondition</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">typeDegradedMyApp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Status</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionTrue</span><span class="p">,</span> <span class="nx">Reason</span><span class="p">:</span> <span class="s">&#34;Finalizing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Message</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Finalizer operations for custom resource %s name were successfully accomplished&#34;</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to update MyApp status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Removing Finalizer for MyApp after successfully perform the operations&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">controllerutil</span><span class="p">.</span><span class="nf">RemoveFinalizer</span><span class="p">(</span><span class="nx">myapp</span><span class="p">,</span> <span class="nx">myappFinalizer</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to remove finalizer for MyApp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to remove finalizer for MyApp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// List all Pods matching the MyApp resource</span>
</span></span><span class="line"><span class="cl">        <span class="nx">podList</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PodList</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">listOpts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">client</span><span class="p">.</span><span class="nx">ListOption</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">client</span><span class="p">.</span><span class="nf">InNamespace</span><span class="p">(</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">client</span><span class="p">.</span><span class="nf">MatchingLabels</span><span class="p">(</span><span class="nf">labelsForMyApp</span><span class="p">(</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">podList</span><span class="p">,</span> <span class="nx">listOpts</span><span class="o">...</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to list pods&#34;</span><span class="p">,</span> <span class="s">&#34;MyApp.Namespace&#34;</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;MyApp.Name&#34;</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">podNames</span> <span class="o">:=</span> <span class="nf">getPodNames</span><span class="p">(</span><span class="nx">podList</span><span class="p">.</span><span class="nx">Items</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nf">equalSlices</span><span class="p">(</span><span class="nx">podNames</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Nodes</span> <span class="p">=</span> <span class="nx">podNames</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to update MyApp status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Create or update pods and services based on MyApp spec</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">podSpec</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Pods</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">foundPod</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">podSpec</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">},</span> <span class="nx">foundPod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">pod</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">Name</span><span class="p">:</span>      <span class="nx">podSpec</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">Labels</span><span class="p">:</span>    <span class="nf">labelsForMyApp</span><span class="p">(</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Spec</span><span class="p">:</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">PodSpec</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">Containers</span><span class="p">:</span> <span class="p">[]</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Container</span><span class="p">{{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Name</span><span class="p">:</span>    <span class="nx">podSpec</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Image</span><span class="p">:</span>   <span class="nx">podSpec</span><span class="p">.</span><span class="nx">Image</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Command</span><span class="p">:</span> <span class="nx">podSpec</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Args</span><span class="p">:</span>    <span class="nx">podSpec</span><span class="p">.</span><span class="nx">Args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Ports</span><span class="p">:</span>   <span class="nx">podSpec</span><span class="p">.</span><span class="nx">ContainerPorts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}},</span>
</span></span><span class="line"><span class="cl">                                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">SetControllerReference</span><span class="p">(</span><span class="nx">myapp</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to set controller reference&#34;</span><span class="p">,</span> <span class="s">&#34;Pod.Namespace&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Pod.Name&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Creating a new Pod&#34;</span><span class="p">,</span> <span class="s">&#34;Pod.Namespace&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Pod.Name&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pod</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to create new Pod&#34;</span><span class="p">,</span> <span class="s">&#34;Pod.Namespace&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Pod.Name&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                          <span class="c1">// Refetch MyApp after creating the pod</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to re-fetch myapp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Update status to reflect successful pod creation</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">meta</span><span class="p">.</span><span class="nf">SetStatusCondition</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">typeAvailableMyApp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Status</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionTrue</span><span class="p">,</span> <span class="nx">Reason</span><span class="p">:</span> <span class="s">&#34;Reconciling&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Message</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Pod %s for custom resource %s created successfully&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to update MyApp status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// Check if the pod exposes any ports and create Services</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">containerPort</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">podSpec</span><span class="p">.</span><span class="nx">ContainerPorts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">serviceName</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s-service&#34;</span><span class="p">,</span> <span class="nx">podSpec</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span> <span class="c1">// Set a fixed name for the Service</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">service</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Service</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Name</span><span class="p">:</span>      <span class="nx">serviceName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Labels</span><span class="p">:</span>    <span class="nf">labelsForMyApp</span><span class="p">(</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">Spec</span><span class="p">:</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">ServiceSpec</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Selector</span><span class="p">:</span> <span class="nf">labelsForMyApp</span><span class="p">(</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Ports</span><span class="p">:</span> <span class="p">[]</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ServicePort</span><span class="p">{{</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nx">Name</span><span class="p">:</span>       <span class="nx">containerPort</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nx">Port</span><span class="p">:</span>       <span class="nx">containerPort</span><span class="p">.</span><span class="nx">ContainerPort</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nx">TargetPort</span><span class="p">:</span> <span class="nx">intstr</span><span class="p">.</span><span class="nf">FromInt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">containerPort</span><span class="p">.</span><span class="nx">ContainerPort</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">}},</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">SetControllerReference</span><span class="p">(</span><span class="nx">myapp</span><span class="p">,</span> <span class="nx">service</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to set controller reference&#34;</span><span class="p">,</span> <span class="s">&#34;Service.Namespace&#34;</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Service.Name&#34;</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Creating a new Service&#34;</span><span class="p">,</span> <span class="s">&#34;Service.Namespace&#34;</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Service.Name&#34;</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">service</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to create new Service&#34;</span><span class="p">,</span> <span class="s">&#34;Service.Namespace&#34;</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Service.Name&#34;</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to get Pod&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">MyAppReconciler</span><span class="p">)</span> <span class="nf">doFinalizerOperationsForMyApp</span><span class="p">(</span><span class="nx">cr</span> <span class="o">*</span><span class="nx">applicationv1alpha1</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Add the cleanup steps that the finalizer should perform here</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Successfully finalized custom resource&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">MyAppReconciler</span><span class="p">)</span> <span class="nf">SetupWithManager</span><span class="p">(</span><span class="nx">mgr</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Manager</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewControllerManagedBy</span><span class="p">(</span><span class="nx">mgr</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">For</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">applicationv1alpha1</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">{}).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Owns</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Owns</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Service</span><span class="p">{}).</span> <span class="c1">// Ensure the controller watches Services</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Complete</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">labelsForMyApp</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;app&#34;</span><span class="p">:</span> <span class="s">&#34;myapp&#34;</span><span class="p">,</span> <span class="s">&#34;myapp_cr&#34;</span><span class="p">:</span> <span class="nx">name</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getPodNames</span><span class="p">(</span><span class="nx">pods</span> <span class="p">[]</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="p">[]</span><span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">podNames</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pods</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">podNames</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">podNames</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">podNames</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">equalSlices</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="modify-myapp_controller_testgo">Modify <code>myapp_controller_test.go</code></h4>
<p>We edit <code>myapp_controller_test.go</code> and we add test cases for the reconciliation logic.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">controller</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//nolint:golint</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span> <span class="s">&#34;github.com/onsi/ginkgo/v2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span> <span class="s">&#34;github.com/onsi/gomega&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">appsv1</span> <span class="s">&#34;k8s.io/api/apps/v1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;k8s.io/apimachinery/pkg/types&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/reconcile&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">applicationv1alpha1</span> <span class="s">&#34;nbfc.io/api/v1alpha1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">_</span> <span class="p">=</span> <span class="nf">Describe</span><span class="p">(</span><span class="s">&#34;MyApp controller&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;MyApp controller test&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kd">const</span> <span class="nx">MyAppName</span> <span class="p">=</span> <span class="s">&#34;test-myapp&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nx">namespace</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Name</span><span class="p">:</span>      <span class="nx">MyAppName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">MyAppName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nx">typeNamespaceName</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">Name</span><span class="p">:</span>      <span class="nx">MyAppName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">MyAppName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">myapp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">applicationv1alpha1</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;Creating the Namespace to perform the tests&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">Expect</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">Not</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;Setting the Image ENV VAR which stores the Operand image&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Setenv</span><span class="p">(</span><span class="s">&#34;MYAPP_IMAGE&#34;</span><span class="p">,</span> <span class="s">&#34;example.com/image:test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">Expect</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">Not</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;creating the custom resource for the Kind MyApp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">err</span> <span class="p">=</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">typeNamespaceName</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// Let&#39;s mock our custom resource at the same way that we would</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// apply on the cluster the manifest under config/samples</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">myapp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">applicationv1alpha1</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Name</span><span class="p">:</span>      <span class="nx">MyAppName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">namespace</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">Spec</span><span class="p">:</span> <span class="nx">applicationv1alpha1</span><span class="p">.</span><span class="nx">MyAppSpec</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Size</span><span class="p">:</span>          <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">ContainerPort</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="nx">err</span> <span class="p">=</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">myapp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="nf">Expect</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">Not</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nf">AfterEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;removing the custom resource for the Kind MyApp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">found</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">applicationv1alpha1</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">typeNamespaceName</span><span class="p">,</span> <span class="nx">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">Expect</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">Not</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">Eventually</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span> <span class="mi">2</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="nf">Should</span><span class="p">(</span><span class="nf">Succeed</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// TODO(user): Attention if you improve this code by adding other context test you MUST</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// be aware of the current delete namespace limitations.</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// More info: https://book.kubebuilder.io/reference/envtest.html#testing-considerations</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;Deleting the Namespace to perform the tests&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">_</span> <span class="p">=</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;Removing the Image ENV VAR which stores the Operand image&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">_</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Unsetenv</span><span class="p">(</span><span class="s">&#34;MYAPP_IMAGE&#34;</span><span class="p">)</span> <span class="c1">// Remove ENV variable after tests</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nf">It</span><span class="p">(</span><span class="s">&#34;should successfully reconcile a custom resource for MyApp&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;Checking if the custom resource was successfully created&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">Eventually</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">found</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">applicationv1alpha1</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">typeNamespaceName</span><span class="p">,</span> <span class="nx">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="nf">Should</span><span class="p">(</span><span class="nf">Succeed</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;Reconciling the custom resource created&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">myappReconciler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">MyAppReconciler</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Client</span><span class="p">:</span> <span class="nx">k8sClient</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Scheme</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">myappReconciler</span><span class="p">.</span><span class="nf">Reconcile</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">reconcile</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">NamespacedName</span><span class="p">:</span> <span class="nx">typeNamespaceName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="p">})</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">Expect</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">Not</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;Checking if Deployment was successfully created in the reconciliation&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">Eventually</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">found</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">typeNamespaceName</span><span class="p">,</span> <span class="nx">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="nf">Should</span><span class="p">(</span><span class="nf">Succeed</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">By</span><span class="p">(</span><span class="s">&#34;Checking the latest Status Condition added to the MyApp instance&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">Eventually</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                                        <span class="nb">len</span><span class="p">(</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">latestStatusCondition</span> <span class="o">:=</span> <span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">myapp</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">expectedLatestStatusCondition</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Type</span><span class="p">:</span>   <span class="nx">typeAvailableMyApp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Status</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionTrue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Reason</span><span class="p">:</span> <span class="s">&#34;Reconciling&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">Message</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                                        <span class="s">&#34;Deployment for custom resource (%s) with %d replicas created successfully&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nx">myapp</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nx">myapp</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Size</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">if</span> <span class="nx">latestStatusCondition</span> <span class="o">!=</span> <span class="nx">expectedLatestStatusCondition</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;The latest status condition added to the MyApp instance is not as expected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="nf">Should</span><span class="p">(</span><span class="nf">Succeed</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><h4 id="modify-application_v1alpha1_myappyaml">Modify <code>application_v1alpha1_myapp.yaml</code></h4>
<p>This YAML file defines the structure of our custom resource. Ensure it reflects the structure and default values we want for MyApp.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">application.nbfc.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MyApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-sample</span><span class="w"> </span><span class="c"># Name of the MyApp resource instance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># List of pods to be deployed as part of this MyApp resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pods</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sleep&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;infinity&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containerPorts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">debian:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sleep&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;infinity&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><h4 id="modify-myapp_typesgo">Modify <code>myapp_types.go</code></h4>
<p>This file defines the schema and validation for our custom resource. Ensure it aligns with the desired specification and status definitions for MyApp.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">v1alpha1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MyAppSpec defines the desired state of MyApp</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">MyAppSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Size</span>          <span class="kt">int32</span>     <span class="s">`json:&#34;size,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ContainerPort</span> <span class="kt">int32</span>     <span class="s">`json:&#34;containerPort,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Pods</span>          <span class="p">[]</span><span class="nx">PodSpec</span> <span class="s">`json:&#34;pods,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// PodSpec defines the desired state of a Pod</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">PodSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Name</span>           <span class="kt">string</span>                 <span class="s">`json:&#34;name&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Image</span>          <span class="kt">string</span>                 <span class="s">`json:&#34;image&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Command</span>        <span class="p">[]</span><span class="kt">string</span>               <span class="s">`json:&#34;command,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Args</span>           <span class="p">[]</span><span class="kt">string</span>               <span class="s">`json:&#34;args,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ContainerPorts</span> <span class="p">[]</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ContainerPort</span> <span class="s">`json:&#34;containerPorts,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MyAppStatus defines the observed state of MyApp</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">MyAppStatus</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Conditions</span> <span class="p">[]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span> <span class="s">`json:&#34;conditions,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;type&#34; protobuf:&#34;bytes,1,rep,name=conditions&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Nodes</span>      <span class="p">[]</span><span class="kt">string</span>           <span class="s">`json:&#34;nodes,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:object:root=true</span>
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:subresource:status</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MyApp is the Schema for the myapps API</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">MyApp</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>   <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">Spec</span>   <span class="nx">MyAppSpec</span>   <span class="s">`json:&#34;spec,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Status</span> <span class="nx">MyAppStatus</span> <span class="s">`json:&#34;status,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//+kubebuilder:object:root=true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MyAppList contains a list of MyApp</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">MyAppList</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Items</span>           <span class="p">[]</span><span class="nx">MyApp</span> <span class="s">`json:&#34;items&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">SchemeBuilder</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">MyApp</span><span class="p">{},</span> <span class="o">&amp;</span><span class="nx">MyAppList</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>After the changes, make sure we run the make command to update the generate files and apply the changes.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make run
</span></span></code></pre></div><p>Deploy the <code>application_v1alpha1_myapp.yaml</code> file to our Kubernetes cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f application_v1alpha1_myapp.yaml
</span></span></code></pre></div><p>Then we check if the deployments are running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get pods -A 
</span></span></code></pre></div><p>Building Kubernetes controllers with KubeBuilder and using CRDs opens up a new level of flexibility and scalability in the Kubernetes platform. Through the process above, we were able to create a custom resource (MyApp) and deploy a controller that manages the lifecycle of that resource within the cluster.</p>
<p>Based on the above process, we built a simple <a href="https://etherpad.org/" target="_blank" rel="noopener"><code>Etherpad</code></a> installation demo, available to test on <a href="https://killercoda.com/nubis/scenario/CRD_Etherpad" target="_blank" rel="noopener"><code>killercoda</code></a>. Stay tuned for more k8s-related posts and tricks!</p>
<ul>
<li><a href="https://killercoda.com/nubis/scenario/test-scenario" target="_blank" rel="noopener">Live demo for CR MyApp</a></li>
<li><a href="https://killercoda.com/nubis/scenario/CRD_Etherpad" target="_blank" rel="noopener">Extra Live demo for CR <code>EtherpadInstance</code></a></li>
</ul>

    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/kubernetes/">Kubernetes</a>
  
  <a class="badge badge-light" href="/tag/crd/">CRD</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=%2Fblog%2Fcrd%2F&amp;text=Kubebuilder%3A&#43;Extending&#43;the&#43;k8s&#43;API&#43;to&#43;match&#43;applications%27&#43;needs" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=%2Fblog%2Fcrd%2F&amp;t=Kubebuilder%3A&#43;Extending&#43;the&#43;k8s&#43;API&#43;to&#43;match&#43;applications%27&#43;needs" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
        
      
      <li>
        <a href="mailto:?subject=Kubebuilder%3A%20Extending%20the%20k8s%20API%20to%20match%20applications%27%20needs&amp;body=%2Fblog%2Fcrd%2F" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=%2Fblog%2Fcrd%2F&amp;title=Kubebuilder%3A&#43;Extending&#43;the&#43;k8s&#43;API&#43;to&#43;match&#43;applications%27&#43;needs" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="whatsapp://send?text=Kubebuilder%3A&#43;Extending&#43;the&#43;k8s&#43;API&#43;to&#43;match&#43;applications%27&#43;needs%20%2Fblog%2Fcrd%2F" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=%2Fblog%2Fcrd%2F&amp;title=Kubebuilder%3A&#43;Extending&#43;the&#43;k8s&#43;API&#43;to&#43;match&#43;applications%27&#43;needs" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
  
  
  <div class="media author-card content-widget-hr">
    
      <a href="/author/charalampos-mainas/"><img class="avatar mr-3 avatar-circle" src="https://s.gravatar.com/avatar/394bd1940f73cb72a4cb2e5c5667cd32?s=200" alt="Charalampos Mainas"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="/author/charalampos-mainas/">Charalampos Mainas</a></h5>
      <h6 class="card-subtitle">Systems Researcher</h6>
      <p class="card-text">PhD candidate focusing on low-level systems programming, Linux kernel development, hypervisors (KVM, Xen) and unikernel runtime ecosystems.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:cmainas@nubificus.co.uk" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/cmainas" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/charalampos-mainas-38b242163/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


















  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  












  
  
  
  
  













  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2026 Nubificus LTD. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>





  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Hugo Blox Builder</a> — the free, <a href="https://github.com/HugoBlox/hugo-blox-builder" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.5faf09821dbe513ca103e87bafd52766.js"></script>




  

  
  

  






  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>



































<script id="page-data" type="application/json">{"use_headroom":true}</script>


  <script src="/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js" type="module"></script>










<script src="/en/js/wowchemy.min.e166a4f802c5f09237cc72919197d83b.js"></script>



  <script src="/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js" type="module"></script>




  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <pre><code></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/wowchemy-publication.9c0e895144aef5a693008b5c5d450147.js" type="module"></script>


















</body>
</html>
